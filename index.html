<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TaskMaster Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #0f172a; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        .spinner { border: 3px solid rgba(79, 70, 229, 0.1); border-top-color: #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .card-enter { animation: slideIn 0.4s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const SVG = {
            Sparkle: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            Camera: () => <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Settings: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Check: () => <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5"/></svg>,
            Refresh: () => <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>,
            Calendar: () => <svg className="w-3 h-3 text-indigo-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
        };

        const App = () => {
            const [keys, setKeys] = useState(() => ({
                gemini: localStorage.getItem('tm_gemini_key') || '',
                google: localStorage.getItem('tm_google_client_id') || ''
            }));
            const [showSettings, setShowSettings] = useState(!keys.gemini || !keys.google);
            const [accessToken, setAccessToken] = useState(null);
            const [tokenClient, setTokenClient] = useState(null);
            const [taskLists, setTaskLists] = useState([]);
            const [selectedList, setSelectedList] = useState('');
            const [tasks, setTasks] = useState(() => JSON.parse(localStorage.getItem('tm_tasks') || '[]'));
            const [inputText, setInputText] = useState('');
            const [imagePreview, setImagePreview] = useState(null);
            const [inputImage, setInputImage] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [status, setStatus] = useState({ type: '', msg: '' });
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (window.google && keys.google) {
                    try {
                        const client = google.accounts.oauth2.initTokenClient({
                            client_id: keys.google,
                            scope: 'https://www.googleapis.com/auth/tasks',
                            callback: (resp) => {
                                if (resp.access_token) {
                                    setAccessToken(resp.access_token);
                                    fetchLists(resp.access_token);
                                }
                            },
                        });
                        setTokenClient(client);
                    } catch (e) { console.error(e); }
                }
            }, [keys.google]);

            const showStatus = (type, msg) => {
                setStatus({ type, msg });
                setTimeout(() => setStatus({ type: '', msg: '' }), 4000);
            };

            const fetchLists = async (token) => {
                try {
                    const r = await fetch('https://tasks.googleapis.com/tasks/v1/users/@me/lists', {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    const d = await r.json();
                    if (d.items) {
                        setTaskLists(d.items);
                        setSelectedList(d.items[0].id);
                    }
                } catch (e) { showStatus('error', 'Auth expired.'); }
            };

            const handleAnalyze = async () => {
                if (!keys.gemini) return setShowSettings(true);
                if (!inputText && !inputImage) return;
                setIsAnalyzing(true);
                try {
                    const now = new Date();
                    const prompt = `Extract tasks and specific deadlines (including time). Today is ${now.toString()}. Return ONLY a JSON array of objects: [{"title":"..", "due":"RFC3339_WITH_TIME_OR_NULL"}]. If an hour is mentioned (e.g. 5pm, 14:30), include it in the due timestamp. No markdown.`;
                    const payload = {
                        contents: [{
                            parts: [
                                { text: prompt + "\n\nContent: " + inputText },
                                ...(inputImage ? [{ inlineData: { mimeType: "image/png", data: inputImage } }] : [])
                            ]
                        }]
                    };
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keys.gemini}`, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    const raw = data.candidates[0].content.parts[0].text;
                    const match = raw.match(/\[.*\]/s);
                    if (!match) throw new Error("Format error");
                    const extracted = JSON.parse(match[0]);
                    const newList = [...tasks, ...extracted.map(t => ({ id: Math.random().toString(36), title: t.title, due: t.due, checked: true }))];
                    setTasks(newList);
                    localStorage.setItem('tm_tasks', JSON.stringify(newList));
                    setInputText(''); setImagePreview(null); setInputImage(null);
                    showStatus('success', `Added ${extracted.length} tasks!`);
                } catch (e) { showStatus('error', 'AI extraction failed.'); }
                finally { setIsAnalyzing(false); }
            };

            const handleSync = async () => {
                if (!accessToken) return tokenClient.requestAccessToken();
                const toSync = tasks.filter(t => t.checked);
                if (toSync.length === 0) return;
                setIsSyncing(true);
                try {
                    for (const t of toSync) {
                        await fetch(`https://tasks.googleapis.com/tasks/v1/lists/${selectedList}/tasks`, {
                            method: 'POST',
                            headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                title: t.title, 
                                due: t.due || undefined 
                            })
                        });
                    }
                    const rem = tasks.filter(t => !t.checked);
                    setTasks(rem);
                    localStorage.setItem('tm_tasks', JSON.stringify(rem));
                    showStatus('success', 'Synced successfully!');
                } catch (e) { showStatus('error', 'Sync failed.'); }
                finally { setIsSyncing(false); }
            };

            const createNewList = async () => {
                const name = prompt("New List Name:");
                if (!name || !accessToken) return;
                try {
                    const res = await fetch('https://tasks.googleapis.com/tasks/v1/users/@me/lists', {
                        method: 'POST',
                        headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: name })
                    });
                    const d = await res.json();
                    setTaskLists([d, ...taskLists]);
                    setSelectedList(d.id);
                } catch (e) { showStatus('error', 'Failed.'); }
            };

            const formatDueDate = (iso) => {
                if (!iso) return null;
                const date = new Date(iso);
                const options = { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' };
                return date.toLocaleString([], options);
            };

            return (
                <div className="max-w-md mx-auto min-h-screen p-5 pb-24">
                    {showSettings && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-50 flex items-center justify-center p-6">
                            <div className="bg-white w-full rounded-[2.5rem] p-8 shadow-2xl border border-slate-100">
                                <h2 className="text-xl font-bold mb-4">Setup</h2>
                                <div className="space-y-4 mb-8">
                                    <input type="password" value={keys.gemini} onChange={e => setKeys({...keys, gemini: e.target.value})} className="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Gemini Key" />
                                    <input type="text" value={keys.google} onChange={e => setKeys({...keys, google: e.target.value})} className="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Google Client ID" />
                                </div>
                                <button onClick={() => { localStorage.setItem('tm_gemini_key', keys.gemini); localStorage.setItem('tm_google_client_id', keys.google); window.location.reload(); }} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg">Save & Launch</button>
                            </div>
                        </div>
                    )}

                    <header className="flex justify-between items-center mb-8 px-2">
                        <h1 className="text-2xl font-black text-indigo-600 tracking-tight flex items-center gap-2">
                            <span className="bg-indigo-600 text-white p-1 rounded-lg"><SVG.Check /></span> TaskMaster
                        </h1>
                        <button onClick={() => setShowSettings(true)} className="p-3 text-slate-300 hover:text-indigo-600 transition-colors"><SVG.Settings /></button>
                    </header>

                    {status.msg && <div className={`mb-6 p-4 rounded-3xl text-xs font-bold border ${status.type === 'error' ? 'bg-red-50 text-red-600 border-red-100' : 'bg-indigo-50 text-indigo-600 border-indigo-100'}`}>{status.msg}</div>}

                    <div className="bg-white rounded-[2.5rem] p-6 shadow-xl border border-slate-50 mb-8">
                        <textarea value={inputText} onChange={e => setInputText(e.target.value)} className="w-full h-32 border-none focus:ring-0 text-sm font-semibold placeholder:text-slate-300 resize-none bg-transparent" placeholder="Snap a photo or type notes with times (e.g. 'Lunch at 2pm tomorrow')..." />
                        {imagePreview && <div className="relative mb-4"><img src={imagePreview} className="w-full h-40 object-cover rounded-3xl border shadow-inner"/><button onClick={() => {setImagePreview(null); setInputImage(null)}} className="absolute top-2 right-2 bg-white/90 p-2 rounded-full shadow-lg text-red-500">Ã—</button></div>}
                        <div className="flex gap-3">
                            <button onClick={() => fileInputRef.current.click()} className="w-14 h-14 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-400 border border-slate-100"><SVG.Camera /></button>
                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={e => {
                                const f = e.target.files[0];
                                const r = new FileReader();
                                r.onloadend = () => { setImagePreview(r.result); setInputImage(r.result.split(',')[1]); };
                                r.readAsDataURL(f);
                            }} />
                            <button onClick={handleAnalyze} disabled={isAnalyzing} className="flex-1 bg-indigo-600 text-white rounded-2xl font-bold text-sm shadow-xl flex items-center justify-center gap-2 active:scale-95 transition-all">
                                {isAnalyzing ? <div className="spinner"></div> : <SVG.Sparkle />} <span>Extract</span>
                            </button>
                        </div>
                    </div>

                    {tasks.length > 0 && (
                        <div className="bg-white rounded-[2.5rem] p-7 shadow-xl border border-slate-50 card-enter">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-[10px] font-black uppercase tracking-widest text-slate-400">Review</h2>
                                <button onClick={() => { setTasks([]); localStorage.removeItem('tm_tasks'); }} className="text-[10px] font-bold text-red-400">Clear</button>
                            </div>
                            <div className="space-y-3 mb-8 max-h-60 overflow-y-auto pr-1 custom-scrollbar">
                                {tasks.map(t => (
                                    <div key={t.id} className="flex items-center gap-3 p-4 bg-slate-50 rounded-2xl transition-all">
                                        <input type="checkbox" checked={t.checked} onChange={() => { const u = tasks.map(i => i.id === t.id ? {...i, checked: !i.checked} : i); setTasks(u); localStorage.setItem('tm_tasks', JSON.stringify(u)); }} className="w-5 h-5 rounded-lg text-indigo-600 focus:ring-0" />
                                        <div className="flex-1 min-w-0">
                                            <p className={`text-xs font-bold leading-tight truncate ${!t.checked && 'text-slate-300 line-through'}`}>{t.title}</p>
                                            {t.due && <p className="text-[10px] font-bold text-indigo-400 mt-1 flex items-center gap-1"><SVG.Calendar /> {formatDueDate(t.due)}</p>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="flex justify-between items-center mb-2 px-1">
                                <label className="text-[10px] font-black uppercase text-slate-400">Google List</label>
                                <button onClick={createNewList} className="text-[10px] font-bold text-indigo-600 underline">New List</button>
                            </div>
                            <select value={selectedList} onChange={e => setSelectedList(e.target.value)} className="w-full bg-slate-50 border-none rounded-xl text-xs font-bold text-slate-600 p-4 mb-4 outline-none">
                                {taskLists.map(l => <option key={l.id} value={l.id}>{l.title}</option>)}
                            </select>
                            <button onClick={handleSync} disabled={isSyncing} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-xs flex items-center justify-center gap-3 active:scale-95 transition-all shadow-xl">
                                {isSyncing ? "Syncing..." : <><SVG.Refresh /> Sync to Google</>}
                            </button>
                        </div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
